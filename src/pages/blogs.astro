---
import PageLayout from "../layouts/PageLayout.astro";
import { getCollection } from "astro:content";

const allPosts = await getCollection("blog");
// Sort posts by date (newest first)
const sortedPosts = allPosts.sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

const featuredPost = sortedPosts.find((p) => p.data.featured) || sortedPosts[0];
const posts = sortedPosts.filter((p) => p !== featuredPost);

// Extract unique tags and sort them alphabetically
const uniqueTags = [...new Set(sortedPosts.map((p) => p.data.tag))].sort();
---

<PageLayout title="Blog - Yash Kukreja">
	<div class="blog-header">
		<div class="blog-header__info">
			<h1 class="blog-header__title font-display">Writing</h1>
			<p class="blog-header__desc text-muted">
				Thoughts on software engineering, product development, and career growth.
			</p>
		</div>
		<div class="blog-filters">
			<button class="filter-btn active" data-filter="all">All</button>
			{uniqueTags.map(tag => (
				<button class="filter-btn" data-filter={tag.toLowerCase()}>{tag}</button>
			))}
		</div>
	</div>

	<article class="card featured-post group" data-category={featuredPost.data.tag.toLowerCase()}>
		<div class="featured-post__image-container">
			<img alt="Featured Post" class="featured-post__image group-hover-scale" src={featuredPost.data.image || "https://lh3.googleusercontent.com/aida-public/AB6AXuBXpAmZxfj-N05vM-XrhKfgRKoKhHjqRxjlrosX3DIKWBQx0MpIEaBLlzHNF8qR8yWs-4_U8eBSCFrTxM11koP0VlH3SZ90HBT8BRoIA5HeQ7fahcfMKullHfI7tbQeF3TtjwTch63RwJ_nEJ9kwNLuH3H2ZtD31Z1azjUx-UTJEBfnTxukcUOYSZBZUh-HZDeSe07nfoM8s16SxgbWXtJTy37qlm2k_JAVkfB9FBx2CChzYCBvImun-4I1iVbX4eOOz4uJj914tQ4"}/>
			<div class="featured-post__overlay"></div>
		</div>
		<div class="featured-post__content">
			<div class="post-meta">
				<span class={`tag ${featuredPost.data.tagClass}`}>{featuredPost.data.tag}</span>
				<span class="read-time text-muted"><i class="fa-regular fa-clock"></i> {featuredPost.data.readTime}</span>
			</div>
			<h2 class="featured-post__title font-display group-hover-primary">
				{featuredPost.data.title}
			</h2>
			<p class="featured-post__desc text-muted">
				{featuredPost.data.description}
			</p>
			<div class="featured-post__footer">
				<span class="read-more group-hover-translate">Read Full Story <i class="fa-solid fa-arrow-right"></i></span>
				<span class="post-date text-muted font-mono">{featuredPost.data.pubDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
			</div>
		</div>
	</article>

	<div class="posts-grid">
		{posts.map(post => (
			<article class="card post-card group" data-category={post.data.tag.toLowerCase()}>
				<div class="post-meta">
					<span class={`tag ${post.data.tagClass}`}>{post.data.tag}</span>
					<span class="post-date text-muted font-mono">{post.data.pubDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
				</div>
				<h3 class="post-card__title font-display group-hover-primary">
					{post.data.title}
				</h3>
				<p class="post-card__desc text-muted">
					{post.data.description}
				</p>
				<div class="post-card__footer">
					<span class="read-time text-muted"><i class="fa-regular fa-clock"></i> {post.data.readTime}</span>
					<span class="read-more">Read More</span>
				</div>
			</article>
		))}
	</div>

	<div class="pagination-container">
		<nav class="pagination" id="pagination-nav">
			<!-- Injected via JS -->
		</nav>
	</div>

	<script>
		document.addEventListener('astro:page-load', () => {
			const filterBtns = document.querySelectorAll('.filter-btn');
			const articles = document.querySelectorAll('.posts-grid article.card');
			const paginationNav = document.getElementById('pagination-nav');
			
			const itemsPerPage = 2; // Fixed number of posts shown per page
			let currentPage = 1;
			let currentFilter = 'all';

			const renderPagination = (totalPages, currentPage) => {
				if (!paginationNav) return;
				
				if (totalPages <= 1) {
					paginationNav.innerHTML = '';
					return;
				}

				let html = `
					<button class="pagination__btn" aria-label="Previous Page" ${currentPage === 1 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
						<i class="fa-solid fa-arrow-left"></i>
					</button>
				`;

				for (let i = 1; i <= totalPages; i++) {
					html += `<button class="pagination__btn ${i === currentPage ? 'pagination__btn--active' : ''}" data-page="${i}">${i}</button>`;
				}

				html += `
					<button class="pagination__btn" aria-label="Next Page" ${currentPage === totalPages ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
						<i class="fa-solid fa-arrow-right"></i>
					</button>
				`;

				paginationNav.innerHTML = html;
				paginationNav.dataset.totalPages = totalPages.toString();
			};

			if (paginationNav) {
				// Use Event Delegation to avoid losing handlers when DOM updates
				paginationNav.addEventListener('click', (e) => {
					const target = e.target.closest('.pagination__btn');
					if (!target || target.hasAttribute('disabled')) return;

					const totalPages = parseInt(paginationNav.dataset.totalPages || '1');

					if (target.getAttribute('aria-label') === 'Previous Page') {
						if (currentPage > 1) {
							currentPage--;
							updateDisplay();
							window.scrollTo({ top: 300, behavior: 'smooth' });
						}
					} else if (target.getAttribute('aria-label') === 'Next Page') {
						if (currentPage < totalPages) {
							currentPage++;
							updateDisplay();
							window.scrollTo({ top: 300, behavior: 'smooth' });
						}
					} else if (target.hasAttribute('data-page')) {
						currentPage = parseInt(target.getAttribute('data-page') || '1');
						updateDisplay();
						window.scrollTo({ top: 300, behavior: 'smooth' });
					}
				});
			}

			const updateDisplay = () => {
				let visibleCount = 0;
				
				// Calculate visible items first
				articles.forEach(article => {
					const category = article.dataset.category || '';
					const matchesFilter = currentFilter === 'all' || category.includes(currentFilter);
					if (matchesFilter) {
						visibleCount++;
					}
				});

				const totalPages = Math.ceil(visibleCount / itemsPerPage);
				
				// Ensure currentPage is within bounds
				if (currentPage > totalPages && totalPages > 0) {
					currentPage = totalPages;
				} else if (totalPages === 0) {
					currentPage = 1;
				}

				renderPagination(totalPages, currentPage);

				let currentItemIndex = 0;
				
				articles.forEach(article => {
					// First apply filter logic
					const category = article.dataset.category || '';
					const matchesFilter = currentFilter === 'all' || category.includes(currentFilter);
					
					if (matchesFilter) {
						currentItemIndex++;
						// Then apply pagination logic to only show items for current page
						const startIndex = (currentPage - 1) * itemsPerPage;
						const endIndex = startIndex + itemsPerPage;
						
						if (currentItemIndex > startIndex && currentItemIndex <= endIndex) {
							article.style.display = '';
						} else {
							article.style.display = 'none';
						}
					} else {
						article.style.display = 'none';
					}
				});

				// Handle featured post visibility logic
				const featuredArticle = document.querySelector('article.featured-post');
				if (featuredArticle) {
					const featuredCategory = featuredArticle.dataset.category || '';
					const featuredMatches = currentFilter === 'all' || featuredCategory.includes(currentFilter);
					
					// Only show featured post on page 1
					if (featuredMatches && currentPage === 1) {
						featuredArticle.style.display = '';
					} else {
						featuredArticle.style.display = 'none';
					}
				}
			};
			
			// Initialize state
			updateDisplay();

			filterBtns.forEach(btn => {
				btn.addEventListener('click', () => {
					filterBtns.forEach(b => b.classList.remove('active'));
					btn.classList.add('active');
					
					currentFilter = btn.dataset.filter || 'all';
					currentPage = 1; // Reset to page 1 on filter
					
					updateDisplay();
				});
			});
		});
	</script>
</PageLayout>

<style lang="scss">
	/* Typography Helpers */
	.font-mono {
		font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
	}
	.text-sm {
		font-size: 0.875rem;
	}

	/* Header */
	.blog-header {
		display: flex;
		flex-direction: column;
		gap: 1.5rem;

		@media (min-width: 768px) {
			flex-direction: row;
			align-items: flex-end;
			justify-content: space-between;
		}

		&__info {
			display: flex;
			flex-direction: column;
			gap: 0.5rem;
		}

		&__title {
			font-size: 2.25rem;
			font-weight: 800;
			letter-spacing: -0.025em;

			@media (min-width: 768px) {
				font-size: 3rem;
			}
		}

		&__desc {
			font-size: 1.125rem;
			max-width: 36rem;
		}
	}

	/* Filters */
	.blog-filters {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
	}

	.filter-btn {
		padding: 0.5rem 1rem;
		border-radius: 9999px;
		background-color: var(--color-card);
		border: 1px solid var(--color-border);
		color: var(--color-muted);
		font-size: 0.875rem;
		font-weight: 500;
		cursor: pointer;
		transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);

		&:hover {
			color: var(--color-primary);
			border-color: rgba(19, 91, 236, 0.3); /* Primary color with transparency */
			transform: scale(1.05);
		}

		&.active {
			background-color: var(--color-primary);
			color: #ffffff;
			border-color: transparent;
			box-shadow: 0 10px 15px -3px rgba(19, 91, 236, 0.2), 0 4px 6px -2px rgba(19, 91, 236, 0.1);
		}
	}

	/* Featured Post */
	.featured-post {
		display: grid;
		grid-template-columns: 1fr;
		padding: 0;
		cursor: pointer;

		@media (min-width: 768px) {
			grid-template-columns: repeat(2, minmax(0, 1fr));
		}

		&__image-container {
			height: 16rem;
			position: relative;
			overflow: hidden;

			@media (min-width: 768px) {
				height: auto;
			}
		}

		&__image {
			width: 100%;
			height: 100%;
			object-fit: cover;
			transition: transform 0.7s cubic-bezier(0.4, 0, 0.2, 1);
		}

		&__overlay {
			position: absolute;
			inset: 0;
			background: linear-gradient(to top, rgba(0, 0, 0, 0.6), transparent);
			
			@media (min-width: 768px) {
				display: none;
			}
		}

		&__content {
			padding: 2rem;
			display: flex;
			flex-direction: column;
			justify-content: center;
			gap: 1rem;
			position: relative;

			@media (min-width: 768px) {
				padding: 2.5rem;
			}
		}

		&__title {
			font-size: 1.5rem;
			font-weight: 700;
			transition: color 0.3s;

			@media (min-width: 768px) {
				font-size: 1.875rem;
			}
		}

		&__desc {
			line-height: 1.625;
			margin-bottom: 1rem;
		}

		&__footer {
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 1rem;
			margin-top: auto;
		}
	}

	/* Utility Grid Classes */
	.posts-grid {
		display: grid;
		grid-template-columns: repeat(1, minmax(0, 1fr));
		gap: 1.5rem;

		@media (min-width: 768px) {
			grid-template-columns: repeat(2, minmax(0, 1fr));
		}
	}

	/* Post Card */
	.post-card {
		display: flex;
		flex-direction: column;
		height: 100%;
		cursor: pointer;

		&__title {
			font-size: 1.25rem;
			font-weight: 700;
			margin-bottom: 0.75rem;
			line-height: 1.375;
			transition: color 0.3s;
		}

		&__desc {
			font-size: 0.875rem;
			line-height: 1.625;
			margin-bottom: 1.5rem;
			flex-grow: 1;
		}
	}

	/* Meta & Tags */
	.post-meta {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 1rem;
		gap: 0.5rem;
		flex-wrap: wrap;
	}

	.post-date {
		font-size: 13px;
	}

	.tag {
		padding: 0.25rem 0.75rem;
		border-radius: 9999px;
		font-size: 0.75rem;
		font-weight: 700;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		white-space: nowrap;

		&-career {
			background-color: rgba(19, 91, 236, 0.1); /* primary/10 */
			color: var(--color-primary);
		}

		&-tech {
			background-color: rgba(37, 99, 235, 0.1);
			color: #2563eb;
			.dark & {
				background-color: rgba(59, 130, 246, 0.2);
				color: #60a5fa;
			}
		}

		&-productivity {
			background-color: rgba(147, 51, 234, 0.1);
			color: #9333ea;
			.dark & {
				background-color: rgba(168, 85, 247, 0.2);
				color: #c084fc;
			}
		}

		&-tutorial {
			background-color: rgba(22, 163, 74, 0.1);
			color: #16a34a;
			.dark & {
				background-color: rgba(34, 197, 94, 0.2);
				color: #4ade80;
			}
		}

		&-design {
			background-color: rgba(234, 88, 12, 0.1);
			color: #ea580c;
			.dark & {
				background-color: rgba(249, 115, 22, 0.2);
				color: #fb923c;
			}
		}

		&-system-design {
			background-color: rgba(219, 39, 119, 0.1);
			color: #db2777;
			.dark & {
				background-color: rgba(236, 72, 153, 0.2);
				color: #f472b6;
			}
		}
	}

	.read-time {
		display: flex;
		align-items: center;
		gap: 0.25rem;
		font-size: 0.75rem;
		font-weight: 500;
	}

	.read-more {
		font-size: 0.875rem;
		font-weight: 600;
		color: var(--color-primary);
		display: inline-flex;
		align-items: center;
		gap: 0.25rem;
		transition: transform 0.3s;
	}

</style>

<style is:global lang="scss">
	/* Pagination */
	.pagination-container {
		display: flex;
		justify-content: center;
		margin-top: 2rem;
	}

	.pagination {
		display: flex;
		gap: 0.5rem;

		&__btn {
			width: 2.5rem;
			height: 2.5rem;
			border-radius: 9999px;
			display: flex;
			align-items: center;
			justify-content: center;
			border: 1px solid var(--color-border);
			background-color: var(--color-card);
			color: var(--color-muted);
			cursor: pointer;
			transition: all 0.2s;
			font-size: 0.875rem;

			&:hover {
				color: var(--color-primary);
				border-color: var(--color-primary);
			}

			&--active {
				background-color: var(--color-primary);
				color: #ffffff;
				font-weight: 700;
				border-color: transparent;
				box-shadow: 0 10px 15px -3px rgba(19, 91, 236, 0.2), 0 4px 6px -2px rgba(19, 91, 236, 0.1);
				
				&:hover {
					color: #ffffff;
				}
			}
		}

		&__dots {
			width: 2.5rem;
			height: 2.5rem;
			display: flex;
			align-items: center;
			justify-content: center;
		}
	}
</style>

<style lang="scss">
	/* Group Hover Utilities */
	.group:hover {
		.group-hover-scale {
			transform: scale(1.05);
		}
		
		.group-hover-primary {
			color: var(--color-primary);
		}

		.group-hover-translate {
			transform: translateX(0.25rem);
		}
	}
</style>
