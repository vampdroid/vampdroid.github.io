---
import './chat.scss';

const defaultFirstAIMessages = [
	'Konichiwa, I am Yash Kukreja. Ask me anything?',
	'Hello, I am Yash Kukreja. How can I assist you today?',
	'Hi there! I am Yash Kukreja\'s AI assistant, Ask me anything about Yash (it will remain between us okay?!)',
	'Greetings! I am Yash Kukreja\'s AI assistant. What would you like to know?',
];
const initialMessage = defaultFirstAIMessages[Math.floor(Math.random() * defaultFirstAIMessages.length)];
---

<div class="flex-1 w-full max-w-3xl mx-auto flex flex-col relative z-0 chat-wrapper" style="display: flex; flex-direction: column; flex: 1; width: 100%; max-width: 48rem; margin: 0 auto; position: relative; height: 100%;">
	
	<div class="text-center mb-8" style="text-align: center; margin-bottom: 2rem;">
		<p class="text-sm" style="color: var(--color-muted); font-size: 0.875rem;">Ask me anything about my work, skills, or projects.</p>
	</div>

	<div id="chat-messages-container" class="flex-1 overflow-y-auto space-y-6 pr-2 mb-6 scroll-smooth chat-container" style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 1.5rem; padding-right: 0.5rem; margin-bottom: 1.5rem; padding-bottom: 1rem;">
		<!-- Initial AI Message -->
		<div class="flex items-start gap-4 max-w-[90%]" style="display: flex; align-items: flex-start; gap: 1rem; max-width: 90%; margin-left: 0; flex-direction: row;">
			<div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg" style="width: 2.5rem; height: 2.5rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background: linear-gradient(to bottom right, #6366f1, #9333ea); box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.2);">
				<i class="fa-solid fa-robot text-white text-sm" style="color: white; font-size: 0.875rem;"></i>
			</div>
			<div class="flex flex-col gap-1" style="display: flex; flex-direction: column; gap: 0.25rem; align-items: flex-start;">
				<span class="text-xs font-semibold" style="font-size: 0.75rem; font-weight: 600; color: var(--color-muted); margin: 0 0 0 0.25rem;">
					AI Assistant
				</span>
				<div class="glass-bubble rounded-tl-none rounded-2xl px-6 py-4 leading-relaxed" style="border-radius: 1rem; border-top-left-radius: 0; padding: 1rem 1.5rem; line-height: 1.625; color: var(--color-text);">
					<p>{initialMessage}</p>
				</div>
			</div>
		</div>
		<!-- Dynamically added messages go here -->
	</div>

	<!-- Loading Indicator (Hidden by default) -->
	<div id="chat-loading-indicator" class="flex items-start gap-4 max-w-[90%] hidden" style="display: none; align-items: flex-start; gap: 1rem; max-width: 90%;">
		<div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg" style="width: 2.5rem; height: 2.5rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background: linear-gradient(to bottom right, #6366f1, #9333ea); box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.2);">
			<i class="fa-solid fa-robot text-white text-sm" style="color: white; font-size: 0.875rem;"></i>
		</div>
		<div class="flex flex-col gap-1" style="display: flex; flex-direction: column; gap: 0.25rem;">
			<span class="text-xs font-semibold" style="font-size: 0.75rem; font-weight: 600; color: var(--color-muted); margin-left: 0.25rem;">AI Assistant</span>
			<div class="glass-bubble rounded-2xl rounded-tl-none px-6 py-4 shadow-sm w-24 flex items-center justify-center gap-1.5" style="border-radius: 1rem; border-top-left-radius: 0; padding: 1rem 1.5rem; width: 6rem; display: flex; align-items: center; justify-content: center; gap: 0.375rem;">
				<div class="w-2 h-2 bg-gray-400 rounded-full typing-dot" style="width: 0.5rem; height: 0.5rem; background-color: var(--color-muted); border-radius: 9999px;"></div>
				<div class="w-2 h-2 bg-gray-400 rounded-full typing-dot" style="width: 0.5rem; height: 0.5rem; background-color: var(--color-muted); border-radius: 9999px;"></div>
				<div class="w-2 h-2 bg-gray-400 rounded-full typing-dot" style="width: 0.5rem; height: 0.5rem; background-color: var(--color-muted); border-radius: 9999px;"></div>
			</div>
		</div>
	</div>

	<div class="relative w-full mt-auto">
		<div class="absolute inset-0 bg-gradient-to-t -top-12 z-0 pointer-events-none h-12" style="background-image: linear-gradient(to top, var(--color-bg), var(--color-bg), transparent);"></div>
		<div class="chat-input-wrapper rounded-2xl p-2 flex items-center shadow-lg relative z-10 transition-colors" style="display: flex; padding: 0.5rem; border-radius: 1rem; align-items: center;">
			<div 
				id="chat-input-field"
				contenteditable="plaintext-only" 
				class="chat-input" 
				name="user-message" 
				placeholder="Type your message..." 
				style="flex: 1; padding: 0.75rem 1rem; outline: none; background-color: transparent; min-height: 1.5rem; max-height: 150px; overflow-y: auto; font-size: 1rem;"
			></div>
			<button 
				id="chat-submit-btn"
				class="bg-white hover:bg-gray-200 transition-colors rounded-xl p-3 flex items-center justify-center cursor-pointer" 
				style="background-color: var(--color-text); color: var(--color-bg); padding: 0.75rem; border-radius: 0.75rem; border: none; display: flex;"
			>
				<i class="fa-solid fa-paper-plane text-sm"></i>
			</button>
		</div>
	</div>
</div>

<script>
	function initChat() {
		const inputField = document.getElementById('chat-input-field');
		const submitBtn = document.getElementById('chat-submit-btn');
		const messagesContainer = document.getElementById('chat-messages-container');
		const loadingIndicator = document.getElementById('chat-loading-indicator');

		if (!inputField || !submitBtn || !messagesContainer) return;

		const scrollToBottom = () => {
			messagesContainer.scrollTop = messagesContainer.scrollHeight;
		};

		const appendUserMessage = (text) => {
			const html = `
				<div class="flex items-start gap-4 max-w-[90%] ml-auto flex-row-reverse" style="display: flex; align-items: flex-start; gap: 1rem; max-width: 90%; margin-left: auto; flex-direction: row-reverse;">
					<div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 border" style="width: 2.5rem; height: 2.5rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background-color: var(--color-card); border-color: var(--color-border); border-style: solid; border-width: 1px;">
						<i class="fa-solid fa-user text-sm" style="color: var(--color-muted); font-size: 0.875rem;"></i>
					</div>
					<div class="flex flex-col gap-1 items-end" style="display: flex; flex-direction: column; gap: 0.25rem; align-items: flex-end;">
						<span class="text-xs font-semibold" style="font-size: 0.75rem; font-weight: 600; color: var(--color-muted); margin: 0 0.25rem 0 0;">You</span>
						<div class="user-bubble rounded-tr-none text-white rounded-2xl px-6 py-4 leading-relaxed" style="border-radius: 1rem; border-top-right-radius: 0; padding: 1rem 1.5rem; line-height: 1.625; color: #ffffff;">
							<p>${text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>
						</div>
					</div>
				</div>
			`;
			messagesContainer.insertAdjacentHTML('beforeend', html);
			scrollToBottom();
		};

		const appendAIMessage = (text) => {
			const html = `
				<div class="flex items-start gap-4 max-w-[90%]" style="display: flex; align-items: flex-start; gap: 1rem; max-width: 90%; margin-left: 0; flex-direction: row;">
					<div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg" style="width: 2.5rem; height: 2.5rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background: linear-gradient(to bottom right, #6366f1, #9333ea); box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.2);">
						<i class="fa-solid fa-robot text-white text-sm" style="color: white; font-size: 0.875rem;"></i>
					</div>
					<div class="flex flex-col gap-1" style="display: flex; flex-direction: column; gap: 0.25rem; align-items: flex-start;">
						<span class="text-xs font-semibold" style="font-size: 0.75rem; font-weight: 600; color: var(--color-muted); margin: 0 0 0 0.25rem;">AI Assistant</span>
						<div class="glass-bubble rounded-tl-none rounded-2xl px-6 py-4 leading-relaxed" style="border-radius: 1rem; border-top-left-radius: 0; padding: 1rem 1.5rem; line-height: 1.625; color: var(--color-text);">
							<p>${text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>
						</div>
					</div>
				</div>
			`;
			messagesContainer.insertAdjacentHTML('beforeend', html);
			scrollToBottom();
		};

		const toggleLoading = (show) => {
			if (show) {
				loadingIndicator.style.display = 'flex';
				messagesContainer.appendChild(loadingIndicator); // Move to bottom
				scrollToBottom();
			} else {
				loadingIndicator.style.display = 'none';
			}
		};

		const askAI = async (prompt) => {
			appendUserMessage(prompt);
			toggleLoading(true);

			try {
				const res = await fetch('https://portfolio-datalayer.vercel.app/api/chat', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ prompt }),
				});

				const data = await res.json();
				toggleLoading(false);
				
				if (data && data.candidates && data.candidates[0]) {
					appendAIMessage(data.candidates[0].content.parts[0].text);
				} else {
					appendAIMessage("Sorry, I didn't get a valid response.");
				}
			} catch (error) {
				console.error(error);
				toggleLoading(false);
				appendAIMessage("I'm sorry, I'm having trouble connecting to my brain right now. Please try again later.");
			}
		};

		const handleSubmit = (e) => {
			e.preventDefault();
			const userMessage = inputField.innerText.trim();
			if (userMessage) {
				inputField.innerText = '';
				inputField.blur();
				askAI(userMessage);
			}
		};

		inputField.addEventListener('keydown', (e) => {
			if (e.key === 'Enter' && !e.shiftKey) {
				e.preventDefault();
				handleSubmit(e);
			}
		});

		inputField.addEventListener('blur', () => {
			if (inputField.innerHTML === '<br>') {
				inputField.innerText = '';
			}
		});

		submitBtn.addEventListener('click', handleSubmit);
	}

	// Initialize on page load and after Astro View Transitions swap
	document.addEventListener('astro:page-load', initChat);
	// Handle initial direct load
	if (document.readyState === 'complete' || document.readyState === 'interactive') {
		setTimeout(initChat, 0);
	} else {
		document.addEventListener('DOMContentLoaded', initChat);
	}
</script>
